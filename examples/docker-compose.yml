version: "3.9"

services:
  proxy:
    build:
      context: ..
      dockerfile: Dockerfile
    command: ["/usr/local/bin/huginn-proxy", "/config/compose.toml"]
    volumes:
      - ./config/compose.toml:/config/compose.toml:ro
      - ./certs:/config/certs:ro
    ports:
      - "7000:7000"   # Proxy server (HTTPS/HTTP)
      - "9090:9090"   # Observability server (Metrics + Health checks)
    # Healthcheck is performed externally by Docker/Kubernetes
    # For Kubernetes, use HTTP probes:
    #   livenessProbe:
    #     httpGet:
    #       path: /health
    #       port: 9090
    #   readinessProbe:
    #     httpGet:
    #       path: /ready
    #       port: 9090
    # For Docker Compose, healthcheck can be done externally using:
    #   docker inspect --format='{{.State.Health.Status}}' <container>
    # Or monitor the /health endpoint from outside the container
    depends_on:
      backend-a:
        condition: service_started
      backend-b:
        condition: service_started

  backend-a:
    build:
      context: ..
      dockerfile: examples/backend/Dockerfile

  backend-b:
    build:
      context: ..
      dockerfile: examples/backend/Dockerfile

